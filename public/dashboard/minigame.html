<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grogugame</title>

    <link rel="stylesheet" href="../css/minigame.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

</head>

<body onload="buscarLadoForca()">
    <div class="janela">
        <div class="headerLeft" id="headerLeft">
            <h1 id="tituloPagina">Star Legends</h1>

            <div class="hello">
                <h3 id="boasVindas">Olá, <span id="id_usuario"></span>!</h3>
            </div>

            <div class="btnNavWhite" id="minigame">

                <h3>Minigame</h3>
                </a>
            </div>

            <div class="btnNav" id="btnNav">
                <a href="../dashboard/dashboard.html" style="text-decoration: none;">
                    <h3>Gráficos</h3>
                </a>

            </div>

            <div class="btnNavWhite" id="btnNavWhite">
                <a href="../quiz.html" style="text-decoration: none;">
                    <h3>Quiz</h3>
                </a>
            </div>

            <div id="btnLogout" class="btnLogout" onclick="sair()">
                <h3>Sair</h3>
            </div>

        </div>

    </div>
    <div class="game">
        <div class="container" id="container1">
            <H1 class="pixel">GROGUGAME</H1>
            <p class="pixel">Aperte START para iniciar</p>
            <button class="pixel" onclick="start()">START</button>
        </div>
        <div class="container" id="container2" style="display: none;">
            <img src="../assets/img/nuvens.png" alt="" class="nuvem">
            <img src="../assets/img/stormtrooper.png" alt="" class="stormtrooper">
            <img src="../assets/img/pixelgrogu-pixelgrogunft.gif" alt="" class="yoda">
            <p>Pontuação: <span id="pontuacao"></span></p>
            <p><span id="cronometro"></span></p>
            <div class="gameover" id="container3" style="display: none;">
                <h1 class="pixel">GAME OVER</h1>
                <P class="pixel">Veja seu histórico na tela de dashboards!</P>
                <!-- <button class="pixel" onclick="restart()">RESTART</button> -->
            </div>
        </div>
    </div>
</body>

</html>
<script>
    let b_usuario = sessionStorage.ID_USUARIO;
    id_usuario.innerHTML = sessionStorage.NOME_USUARIO;


    var tempoFinal = 0
    var pontuacaoFinal = 0
    var pontos = 0
    var minutos = 0
    var segundos = 0

    var yoda = document.querySelector('.yoda')
    var stormTrooper = document.querySelector('.stormtrooper')
    var nuvem = document.querySelector('.nuvem')

    function pular() {
        yoda.classList.add('pular')

        setTimeout(() => {
            yoda.classList.remove('pular')
        }, 500)
    }

    function start() {
        container1.style.display = 'none'
        container2.style.display = 'block'


        var loop = setInterval(() => {

            var posicaoStorm = stormTrooper.offsetLeft;
            var posicaoYoda = +window.getComputedStyle(yoda).bottom.replace('px', '');
            var posicaoNuvem = nuvem.offsetLeft;
            // console.log(posicaoStorm)
            if (posicaoStorm <= 50 && posicaoStorm > 0 && posicaoYoda < 113) {
                stormTrooper.style.animation = 'none'
                stormTrooper.style.left = `${posicaoStorm}px`

                yoda.style.animation = 'none'
                yoda.style.bottom = `${posicaoYoda}px`
                yoda.src = '../assets/img/yodaEscondido.png'

                nuvem.style.animation = 'none'
                nuvem.style.left = `${posicaoNuvem}px`

                container3.style.display = 'flex'


                clearInterval(loop)
                clearInterval(contador)

                pontuacaoFinal = pontos;
                tempoFinal = cronometro.innerHTML

                console.log(pontuacaoFinal)
                console.log(tempoFinal)

                 fetch("/minigame/guardar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          tempoFinalServer: tempoFinal,
          pontuacaoFinalServer: pontuacaoFinal,
          idUsuarioServer: b_usuario

        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta);

          if (resposta.ok) {
            setTimeout(() => {
              window.location = "./dashboard.html";
            }, 3000);
          } else {
            throw "Houve um erro ao tentar realizar o cadastro!";
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
        });
            }

        }, 10)

        var contador = setInterval(() => {
            segundos++

            if (segundos == 59) {
                pontos += 30
                segundos = 0
                minutos++
            }

            var dezenaSeg = Math.floor(segundos / 10).toString()
            var unidadeSeg = (segundos % 10).toString()
            var segundosFormatados = dezenaSeg + unidadeSeg


            var dezenaMin = Math.floor(minutos / 10).toString()
            var unidadeMin = (minutos % 10).toString()
            var minutosFormatados = dezenaMin + unidadeMin
            cronometro.innerHTML = `00:${minutosFormatados}:${segundosFormatados}`


            pontos = pontos + 10
            pontuacao.innerHTML = `${pontos}`


        }, 200)


    }

    document.addEventListener('keydown', pular)



function buscarLadoForca() {

        fetch(`/resultadoQuiz/resultado/${b_usuario}`, { cache: 'no-store' }).then(function (response) {

            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log('chegou aqui')

                    var lado = resposta[0].lado_forca;

                    if (lado == 1) {
                       
                        tituloPagina.style.color = '#c21414';
                        boasVindas.style.color = '#9f1111';
                        id_usuario.style.color = '#9f1111';
                        minigame.style.borderColor = '#b91e1e';
                        btnNav.style.backgroundColor = '#ad1717';
                        headerLeft.style.borderColor = '#b61111';
                        btnNavWhite.style.backgroundColor = '#ad1717';
                        btnLogout.style.backgroundColor = "#b01313";
                      

                        

                    }
                    else if (lado == 0) {

                        tituloPagina.style.color = '#0c9b00';
                        boasVindas.style.color = '#0a6203';
                        id_usuario.style.color = '#0a6203';
                        minigame.style.borderColor = '#15b807';
                        btnNav.style.backgroundColor = '#15b807';
                        headerLeft.style.borderColor = '#15b807';
                        btnNavWhite.style.borderColor = '#15b807';
                        btnLogout.style.backgroundColor = "#15b807";
                        


                    }
                    else {
                        tituloPagina.style.color = '#0c58d8';
                        boasVindas.style.color = '#0c3a86';
                        id_usuario.style.color = '#0c3a86';
                        minigame.style.borderColor = '#0346b8';
                        btnNav.style.backgroundColor = '#0346b8';
                        headerLeft.style.borderColor = '#0346b8';
                        btnNavWhite.style.borderColor = '#0346b8';
                        btnLogout.style.backgroundColor = "#0346b8";



                    }

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API cor da dash');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
            });
    }



</script>